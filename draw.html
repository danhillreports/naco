<html>
<head>

<title>Draw the border!</title>

<link rel=stylesheet href="style.css" type="text/css">

<script>
var map;
var poly;
var frontera;
var tableId = '1aJ_-XLrNBF8x1xvmCDBSzStfNh6cKNFEGmgqXiI';

function initialize() {

    data = $.getJSON("data/counties.json", function(d) {
        data = d;
        console.log(data);
    });

    var cities = new Array();

    var naco = new google.maps.LatLng(31.324607,-109.94595);
    cities[0] = naco;
    var juarez = new google.maps.LatLng(31.748022,-106.413682);
    cities[1] = juarez;
    var tijuana = new google.maps.LatLng(32.546813,-116.977723);
    cities[2] = tijuana;
    var reynosa = new google.maps.LatLng(26.078988,-98.271385);
    cities[3] = reynosa;
    var laredo = new google.maps.LatLng(27.497004,-99.494644);
    cities[4] = laredo;


    map = new google.maps.Map(document.getElementById('map-canvas'), {
        center: juarez,
        zoom: 11,
        mapTypeId: google.maps.MapTypeId.SATELLITE,
        draggable: false,
        disableDoubleClickZoom: true,
        mapTypeControl: false,
        navigationControl: true,
        panControl: false,
        scrollwheel: false,
        streetViewControl: false,
        scaleControl: false,
        zoomControl: false,
        zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL
        },
    });

    frontera = new google.maps.FusionTablesLayer({
        query: {
            select: 'geometry',
            from: tableId,
        },
        styles : [{
        polylineOptions: {
            strokeColor: "#00FF00",
            strokeWeight: "5"  },
        polygonOptions: {
            fillColor: '#00FF00',
            fillOpacity: 0.3
          }
        }],
        options: {
            clickable: false
        }
    });

    var polyOptions = {
        strokeColor: '#000',
        strokeOpacity: 1.0,
        strokeWeight: 2,
        editable: false //users?
      }

    poly = new google.maps.Polyline(polyOptions);
    poly.setMap(map);

    google.maps.event.addListener(map, 'click', addLatLng);

    var lineBoxes = document.createElement('div');
    lineBoxes.id = 'line-boxes';
    lineBoxes.innerHTML='<input type="checkbox" class="box" id="line-edit-check" onclick="editLine()"/><label for="line-edit-check">Edit line</label></br><button id="done-button" onclick="doneDrawing()"/><label for="done-button">Done!</label></button>';
    lineBoxes.index = 1; 
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(lineBoxes);

    return data;
}

  /**
 * Handles click events on a map, and adds a new point to the Polyline.
 * @param {google.maps.MouseEvent} event
 */
function addLatLng(event) {

  var path = poly.getPath();

  // Because path is an MVCArray, we can simply append a new coordinate
  // and it will automatically appear
  path.push(event.latLng);
  console.log(event.latLng)

  // Add a new marker at the new plotted point on the polyline.
  /*var marker = new google.maps.Marker({
    position: event.latLng,
    title: '#' + path.getLength(),
    animation: google.maps.Animation.DROP,
    map: map
  });*/
}

function removePos() {
    var path = poly.getPath();

    //take last point off path
    path.b.pop();

    //clear then reset path
    poly.setMap();
    poly.setMap(map);
}

function editLine() {
    var box = $('#line-edit-check')[0];
    if (box.checked == true) {
        poly.setEditable(true);
    }
    else {
        poly.setEditable(false);
    }
}

function doneDrawing() {
    $('#line-edit-check')[0].checked = false;
    poly.setEditable(false);

    poly.strokeOpacity=0.5;
    poly.setMap();
    poly.setMap(map);

    frontera.setMap(map);
    setTimeout("showInfo()", 1500);
}

function showInfo() {
    var juarezData = getData('juarez');
    var juarezLoc = new google.maps.LatLng(31.58847937271219, -106.60514831542969);
    var juarezWindow = new google.maps.InfoWindow();
    var juarezContent = "<h3>Ciudad Juarez</h3>" +
        "<h5>Juarez, Chihuahua, Mex.</h5>" + 
        "<div style='font-size:12px'><span class='good'>Population</span>: " + juarezData['population'] + "</br>" + 
        "<span class='good'>High school graduates</span>: " + juarezData['grads'] + "</br>" +
        "<span class='bad'>Unemployment rate</span>: " + juarezData['unemployment'] + "</br>" +
        "<span class='bad'>GDP per capita</span>: " + juarezData['gdp'] + "</br>"
        + "</div>";

    juarezWindow.setContent(juarezContent);
    juarezWindow.setPosition(juarezLoc);
    juarezWindow.open(map);

    var pasoData = getData('elpaso');
    var pasoLoc = new google.maps.LatLng(31.693119,-106.316285);
    var pasoWindow = new google.maps.InfoWindow();
    var pasoContent = "<h3>El Paso</h3>" +
        "<h5>El Paso County, Texas, USA</h5>" + 
        "<div style='font-size:12px'><span class='good'>Population</span>: " + pasoData['population'] + "</br>" + 
        "<span class='good'>High school graduates</span>: " + pasoData['grads'] + "</br>" +
        "<span class='bad'>Unemployment rate</span>: " + pasoData['unemployment'] + "</br>" +
        "<span class='bad'>GDP per capita</span>: " + pasoData['gdp'] + "</br>"
        + "</div>";

    pasoWindow.setContent(pasoContent);
    pasoWindow.setPosition(pasoLoc);
    pasoWindow.open(map);

    map.setOptions({draggable:true, scrollwheel:true})
}

function getData(pos) {
    for (var i=0; i<data.length; i++) {
        if (data[i].ID === pos) {
            var regData = data[i];
        }
    }
    return regData;
}

</script>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="js/underscore.js"></script>
<script src="js/backbone.js"></script>
<script src="js/jquery.js"></script>

</head>

<body onload="initialize()">

    <div id="header">
        <h1> Draw the border!</h1>
        <span style="float:right"><img src='img/naco.jpg' href="naco.html" height="42" width="42" border='1px solid black'></br><a href="naco.html">Play "Naco or Naco?"</a></span>
        <span width="400px" style="font-size: small">The <a href="http://online.wsj.com/article/SB10001424127887324695104578416842115318174.html?mod=slideshow_overlay_mod">2,000-mile border</a> between the United States and Mexico divides border city pictured below. Can you draw the line that splits this city?</br>
        Start clicking on the map to create the points to construct your border line and click "Done!" to see the real border in green and learn about the cities on each side.
        <br>Sources: <a href="http://factfinder2.census.gov/faces/nav/jsf/pages/index.xhtml">American Community Survey</a>, <a href="http://www.snim.rami.gob.mx/">Sistema Nacional de Informacion Municipal</a> county data</span> <span style="font-size:.3em">This is a <a href="http://www.chicagomigrahack.com/">Migrahack</a> prototype! Tweet feedback to <a href="https://twitter.com/DanHillReports">@DanHillReports</a>.</span>
    </div>

	<div id="map-canvas"></div>

</body>
</html>
